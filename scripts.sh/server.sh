#!/bin/sh

# NHOS Local Log Server
# By @totakaro 2021
# MIT License

# Check root https://stackoverflow.com/a/18216122
if [ `id -u` -ne 0 ]; then
  echo "Please run as root"
  exit 1
fi

# Import NHOS vars
. /etc/init.d/nhos-functions

# Script vars
VERSION='1.0.6'
INDEX_FILE='/tmp/index.html'
HTTPD_FILE='/tmp/httpd.lua'
RIGS_JSON='rigs.json'
RIGS_JSON_FILE="${NHOS_DATA_DIR}/nhm/configs/${RIGS_JSON}"
NHOS_LOG_NHM_DIR="${NHOS_LOG_DIR}/nhm"
NHM_TXT='nhm.txt'
NHM_TXT_FILE="/tmp/${NHM_TXT}"
NVIDIA_GPU_THERMAL_SLOWDOWN_LOG_FILE="${NHOS_LOG_DIR}/nhos_gpu_nvidia_thermal_slowdown.log"
DEVICE_SETTINGS_JSON='device_settings.json'
NHOS_DEVICE_SETTINGS_FILE="${NHOS_DATA_DIR}/nhm/configs/${DEVICE_SETTINGS_JSON}"
CONFIGURATION_TXT='configuration.txt'
SERVER_PGID='/var/run/ncat_lua_server.pid'

# Main page index.html
cat <<-HTML > "${INDEX_FILE}"
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#031a2a">
    <meta name="color-scheme" content="dark light">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAMAAADzN3VRAAABv1BMVEUAAAD+3Un+3Ur/zxj/41j/2Sr00hXxzgP72jnxzgH52DD920H83EP920L920L31iL52DHxzQL51i3yzQX71y300xbvzgD/zif/5nvxzgT74Wf95X385Xj41ib62Dfyzwf72Tb62jnz0Q/94mn52jz74WTwzQDwzQD51i3z0hn83VbvzQDyzAr43jv22k/xywD/11H/3lD/vQD/6pT6owD/3Uv9t0T/vAD/6JL+uwn/zkT8rhf/uAH6oQD/54P9vU73jwD/547/5Yv/6In/5Xb+1G7/3k393EX7ox3/ugH5nQH/44j90mX+zlv9xk39wEn+0D/+1T78tD39zDr+yi3/yCz7sSH7qBj8qg36qAb6pQT9rQL5mwL5mQL9sAD3kwD/4YP+1HL/42n9x1n/0k/+zk/8vET9zjz8vjv+0Tr+zjb9xDb62TX/yDH9uC38rSz8viv7uCb8pSD7ohb7ng76pQ3/wAv4mwr3lgX+tQL+3Xr/3HP+2Gj+217/31b9x0/+zUr9xUj+1kX+y0D8sTf8rzH7tyr31Sf+xyT+xiT7qSP/xR720x310x37th3/wRP9sBD8pAr2kwH2kgH+sgAvPCdCAAAAMXRSTlMA/f4HCwXu6NXQe/r19fS5ompdSzktHw3++vn28vHt7era18yyq52Zg3xTUlBFNzYTiD6QZAAAAdVJREFUKM9NkvVfG0EQxTeHBy/U3V1m9zR3uYu7EZIQIYRSnCLFWuruDn8wc8cl5Pvjvp157zMzxKblTv+5bo7rvXjjOGmmbfCsADaOK62HwrFLYXwSRnKjqL/267fqwv12fPiqSJRKE6XffsZOHLErUFiIUpuJWFIH7q7l0RWGnEQbaNU1mNJNr8EvsCDlXcj2H1eG/nAt7c4wdhnjdggQ1WSGvH3E2PJDxsaeycz7gAz9hG9U+2QYRlpRjVll3cjytVkWcJLrj0HB7tv1ADwy/jQAnaQrLEhUmmQvlOc+n29STTOv6vYI0Ec6QiOU7gTjyb8+tJILohxXec8cOMhJWMQme5WoVCn+2xzn3dUYz3uWIETOmzU0P52jH5LzxUQwGEyUeE8Gaywfzcu8OzKLf2cmlk8PuWZmi66KK5X17Jh7IxKJbGA2wGy3f0Ge0uXpmTepopp6Vy6k5vnaEwAnzgD8ysEM0jiDFWsGuCVc4E2dvdRWRWRrU8yWI+LH/6MAA+aezzB9scQ3cNfWAHpaCHLvVAheFepCrIoV3DCxONo+xeTE5zL+j22hOThwp7Z0Gv0D8H4uIwDSO9x0O1f9gcbtDLSRZlqH+i90c46+Tmf9pvYB8Fh/Zhrg5acAAAAASUVORK5CYII=" type="image/x-icon">
    <title>NHOS Local Log Server</title>
    <style>
      @media screen and (max-width: 1400px) {
        #oc-settings-gui,
        #tools {
          overflow-x: scroll;
          white-space: nowrap;
        }
      }

      #logs span,
      #rig span {
        color: lightgray;
      }

      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #010d15;
      }

      #logo {
        position: absolute;
        top: 14px;
        cursor: pointer;
      }

      #logs,
      #rig-info {
        padding: 5px;
        color: lightgray;
        background: #010d15;
        margin: 0;
        overflow-x: auto;
        font-family: Consolas, monospace;
        font-size: 10pt;
      }

      #rig-info {
        white-space: pre-wrap;
      }

      #tools {
        position: fixed;
        background: #031a2a;
        width: 100%;
        top: 0;
        padding: 10px;
        box-sizing: border-box;
        border-bottom: 1px solid #40494f;
        z-index: 1;
      }

      #oc-settings, #config-txt {
        padding: 5px;
        color: lightgray;
        background: #010d15;
        margin: 0;
        width: 100%;
        height: 80vh;
        border: 0;
        box-sizing: border-box;
        border-radius: 0;
        white-space: pre;
      }

      #rig-info-title,
      #oc-title,
      #logs-title,
      #rigs-list-title,
      #config-title {
        background: #031a2a;
        font-weight: bold;
        border-bottom: 1px solid #40494f;
      }

      #oc-title,
      #config-title,
      #logs-title {
        border-top: 1px solid #40494f;
      }

      #rig-info-title,
      #oc-title,
      #logs-title,
      #oc-settings-gui,
      #rigs-list-title,
      #rigs-list,
      #config-title,
      #config-gui {
        font-size: 10pt;
        color: #dedede;
        font-family: Consolas, monospace;
        padding: 5px;
      }

      #rigs-list-title,
      #rigs-list  {
        display: none;
      }

      #oc-settings-gui,
      #rigs-list,
      #config-gui {
        background: #010d15;
        line-height: 1.8;
      }

      #oc-title,
      #config-title,
      #oc-save,
      #config-save {
        display: none;
      }

      #oc-settings-gui input[type="range"] {
        margin-right: 20px;
      }

      #oc-settings-gui input[type="number"],
      #config-gui input[type="number"] {
        width: 50px;
        margin: 0 10px;
        background: #d3d1d1;
        border: 0;
        color: #151515;
      }

      #tools button {
        margin: 5px;
      }

      #tools label {
        font-size: 10px;
        text-transform: uppercase;
        font-weight: bold;
        margin-right: 5px;
        color: white;
      }

      button {
        border-radius: 4px;
        border: 0;
        transition: box-shadow .2s ease,border-radius .2s ease,border-radius .2s ease;
        cursor: pointer;
        font-weight: 700;
        text-transform: uppercase;
        overflow: hidden;
        text-overflow: ellipsis;
        background: #fff;
        color: #3a3939;
        box-shadow: 0 1px 4px 0 rgba(35,35,35,.16);
        font-size: 10px;
        letter-spacing: .4px;
        padding: 6px!important;
        margin: 0;
      }

      button:hover {
        box-shadow: 0 4px 12px 0 rgb(255 255 255 / 58%);
      }

      button:disabled {
        color: #afafaf;
        cursor: not-allowed;
        background: #ffffffd9;
      }

      #rig-add, #rigs-all {
        background: linear-gradient(90deg,#fba342,#fbc241);
        color: #fff;
        box-shadow: 0 20px 4px -18px rgba(251,163,66,.32);
      }

      #rig-add:hover, #rigs-all:hover {
        box-shadow: 0 6px 16px 0 rgba(251,163,66,.56);
      }

      .remove {
        background: linear-gradient(90deg,#ff3838,#f37171);
        color: #fff;
        box-shadow: 0 20px 4px -18px rgb(251 66 66 / 32%);
      }

      .remove:hover:not(.disabled) {
        box-shadow: 0 6px 16px 0 rgb(251 66 66 / 56%);
      }

      .open {
        background: linear-gradient(90deg,#4263fb,#418ffb);
        color: #fff;
        box-shadow: 0 20px 4px -18px rgb(66 133 251 / 32%);
      }

      .open:hover:not(.disabled) {
        box-shadow: 0 6px 16px 0 rgb(66 136 251 / 56%);
      }

      button:active {
        box-shadow: none!important;
      }

      .rig-item {
        margin: 10px;
        border: 1px solid #40494f;
        display: inline-block;
      }

      .rig-item-ip {
        font-weight: bold;
        padding: 10px 10px 0 10px;
        display: block;
      }

      .rig-item-actions {
        padding: 10px
      }

      .online {
        background: #dbeed233;
        color: #a4f37c;
      }

      .offline {
        background: #ffa0a026;
        color: #ffc6c6;
      }

      #tools sup {
        margin-left: 208px;
      }

      #tools sup a {
        color: #e2e2e2;
      }
    </style>
  </head>

  <body>
    <div id="tools">
      <svg id="logo" width="53.7mm" height="6.565mm" version="1.1" viewBox="0 0 53.7 6.565" xmlns="http://www.w3.org/2000/svg">
      <g transform="translate(61.119 -69.661)">
        <g transform="matrix(.048462 0 0 .048462 -57.616 68.327)">
        <g transform="matrix(.27646 0 0 .27646 -72.269 27.517)">
          <path d="m490 245c0 135.31-109.69 245-245 245-71.33 0-135.54-30.48-180.31-79.13-11.76-12.77-22.17-26.8-31.03-41.85-21.39-36.38-33.66-78.77-33.66-124.02 0-135.31 109.69-245 245-245 45.26 0 87.65 12.27 124.02 33.67 15.05 8.85 29.07 19.26 41.84 31.03 48.65 44.75 79.14 108.97 79.14 180.3z" fill="#f0cd00"/>
          <path d="m490 245c0 132.26-104.79 240.04-235.88 244.83-131.09-4.79-235.88-112.57-235.88-244.83s104.79-240.04 235.88-244.83c131.09 4.79 235.88 112.57 235.88 244.83z" fill="#ffde50"/>
          <path d="m410.86 64.7-346.17 346.17c-11.76-12.77-22.17-26.8-31.03-41.85l335.36-335.35c15.05 8.85 29.07 19.26 41.84 31.03z" fill="#ffea94"/>
          <path d="m473.1 155.43-317.68 317.68c-22.49-8.84-43.36-20.91-62.03-35.64l344.08-344.08c14.73 18.67 26.8 39.54 35.63 62.04z" fill="#ffea94"/>
          <path d="m435.38 245c0 105.14-85.24 190.38-190.38 190.38-36.62 0-70.82-10.34-99.85-28.26-12.65-7.8-24.31-17.05-34.77-27.51-7.69-7.68-14.73-16.03-21.02-24.94-8.66-12.27-15.91-25.61-21.5-39.78-8.28-20.95-12.94-43.73-13.22-67.55-0.02-0.78-0.02-1.56-0.02-2.34 0-105.14 85.23-190.38 190.38-190.38 0.78 0 1.57 0 2.35 0.02 23.82 0.28 46.59 4.95 67.54 13.22 14.17 5.6 27.51 12.84 39.78 21.5 8.91 6.3 17.25 13.33 24.94 21.02 10.46 10.45 19.71 22.12 27.51 34.77 17.92 29.03 28.26 63.23 28.26 99.85z" fill="#faa300"/>
          <path d="m379.61 110.38-269.23 269.23c-7.69-7.68-14.73-16.03-21.02-24.94-8.66-12.27-15.91-25.61-21.5-39.78-8.28-20.95-12.94-43.73-13.22-67.55-0.02-0.78-0.02-1.56-0.02-2.34 0-105.14 85.23-190.38 190.38-190.38 0.78 0 1.57 0 2.35 0.02 23.82 0.28 46.59 4.95 67.54 13.22 14.17 5.6 27.51 12.84 39.78 21.5 8.91 6.3 17.25 13.33 24.94 21.02z" fill="#ffbd00"/>
          <path d="m435.38 245c0 105.14-85.24 190.38-190.38 190.38-3.61 0-7.19-0.1-10.75-0.3 100.14-5.57 179.62-88.55 179.62-190.08s-79.48-184.51-179.62-190.08c3.56-0.2 7.14-0.3 10.75-0.3 105.14 0 190.38 85.24 190.38 190.38z" fill="#f68e00"/>
        </g>
        <g transform="translate(-.9962 1.8867)" fill="#fa8500">
          <rect x="-40.034" y="62.847" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-5.3569" y="62.847" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="15.378" y="62.847" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-19.299" y="82.174" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-40.213" y="81.321" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="16.093" y="81.606" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="1.7931" y="99.227" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-18.406" y="100.08" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-39.855" y="100.65" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-40.034" y="116.85" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-5.3569" y="116.85" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="15.378" y="116.85" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
        </g>
        <g fill="#ffea94">
          <rect x="-40.034" y="62.847" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-5.3569" y="62.847" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="15.378" y="62.847" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-19.299" y="82.174" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-40.213" y="81.321" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="16.093" y="81.606" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="1.7931" y="99.227" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-18.406" y="100.08" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-39.855" y="100.65" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="-40.034" y="116.85" width="30.387" height="10.8" ry="5.4001" stroke-width="7.1402"/>
          <rect x="-5.3569" y="116.85" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
          <rect x="15.378" y="116.85" width="16.445" height="10.8" ry="5.4001" stroke-width="5.2527"/>
        </g>
        </g>
        <g transform="matrix(.96317 0 0 1 -1.0929 0)" fill="#faa300" stroke-width=".12982" aria-label="NHOS">
        <path d="m-51.324 74.249q0 0.05831-0.02028 0.10395-0.02028 0.04564-0.05578 0.07606-0.03296 0.03043-0.08114 0.04564-0.04564 0.01268-0.09381 0.01268h-0.28397q-0.08874 0-0.15466-0.01775-0.06339-0.01775-0.11917-0.06338-0.05324-0.04817-0.10395-0.12677-0.05071-0.08114-0.1141-0.20791l-0.81642-1.534q-0.071-0.13691-0.14452-0.29411-0.07353-0.15974-0.13184-0.30933h-0.0051q0.01014 0.18255 0.01522 0.36511 0.0051 0.18002 0.0051 0.37271v1.7165q0 0.02536-0.01522 0.04564-0.01268 0.02028-0.04817 0.0355-0.03296 0.01267-0.09128 0.02028-0.05831 0.0076-0.14959 0.0076-0.08874 0-0.14706-0.0076-0.05831-0.0076-0.09128-0.02028-0.03296-0.01522-0.04564-0.0355-0.01267-0.02028-0.01267-0.04564v-2.9487q0-0.11917 0.06846-0.17748 0.071-0.06086 0.17241-0.06086h0.3575q0.09635 0 0.16227 0.01775 0.06593 0.01522 0.11663 0.05324 0.05324 0.03803 0.09888 0.10649 0.04564 0.06592 0.09381 0.1648l0.63894 1.1993q0.05578 0.10902 0.10902 0.21551 0.05578 0.10395 0.10649 0.21044 0.05071 0.10395 0.09888 0.20537 0.04817 0.10142 0.09381 0.20284h0.0026q-0.0076-0.17748-0.01267-0.37018-0.0026-0.1927-0.0026-0.36764v-1.539q0-0.02536 0.01522-0.04564t0.05071-0.0355q0.0355-0.01522 0.09381-0.02029 0.05831-0.0076 0.14959-0.0076 0.08621 0 0.14452 0.0076 0.05831 0.0051 0.08874 0.02029 0.03296 0.01522 0.04564 0.0355 0.01267 0.02028 0.01267 0.04564z"/>
        <path d="m-48.048 74.391q0 0.02536-0.01774 0.04564-0.01522 0.02028-0.05324 0.03296-0.03803 0.01268-0.10142 0.02028-0.06339 0.0076-0.15973 0.0076-0.09888 0-0.16481-0.0076-0.06338-0.0076-0.10142-0.02028-0.0355-0.01268-0.05324-0.03296-0.01522-0.02028-0.01522-0.04564v-1.326h-1.2272v1.326q0 0.02536-0.01522 0.04564t-0.05324 0.03296q-0.03803 0.01268-0.10142 0.02028-0.06339 0.0076-0.16227 0.0076-0.09635 0-0.16227-0.0076-0.06339-0.0076-0.10142-0.02028-0.03803-0.01268-0.05578-0.03296-0.01522-0.02028-0.01522-0.04564v-3.0983q0-0.02536 0.01522-0.04564 0.01774-0.02029 0.05578-0.03296 0.03803-0.01267 0.10142-0.02028 0.06593-0.0076 0.16227-0.0076 0.09888 0 0.16227 0.0076t0.10142 0.02028q0.03803 0.01268 0.05324 0.03296 0.01522 0.02028 0.01522 0.04564v1.2043h1.2272v-1.2043q0-0.02536 0.01522-0.04564 0.01774-0.02029 0.05324-0.03296 0.03803-0.01267 0.10142-0.02028 0.06593-0.0076 0.16481-0.0076 0.09635 0 0.15973 0.0076 0.06338 0.0076 0.10142 0.02028 0.03803 0.01268 0.05324 0.03296 0.01774 0.02028 0.01774 0.04564z"/>
        <path d="m-44.382 72.804q0 0.40821-0.10142 0.73021-0.10142 0.322-0.30172 0.54766-0.2003 0.22312-0.49695 0.34229-0.29411 0.11663-0.68204 0.11663-0.38286 0-0.66936-0.09888-0.28397-0.10142-0.47413-0.30679-0.19016-0.20537-0.28651-0.52231-0.09381-0.31693-0.09381-0.7505 0-0.39807 0.10142-0.715 0.10142-0.31947 0.30172-0.54259 0.2003-0.22312 0.49442-0.34229 0.29665-0.11917 0.68711-0.11917 0.37271 0 0.65668 0.09888 0.28651 0.09888 0.47667 0.30426 0.1927 0.20537 0.28904 0.51977 0.09888 0.31186 0.09888 0.73782zm-0.69979 0.0355q0-0.25862-0.04057-0.46906-0.04057-0.21298-0.13945-0.36257-0.09635-0.15213-0.25862-0.23326-0.16227-0.08367-0.40567-0.08367-0.24594 0-0.41075 0.09381-0.1648 0.09128-0.26622 0.24594-0.10142 0.15466-0.14452 0.36257-0.04057 0.20537-0.04057 0.4361 0 0.26876 0.04057 0.48427 0.04057 0.21298 0.13692 0.36511 0.09635 0.15213 0.25862 0.23326 0.16227 0.0786 0.40821 0.0786 0.24594 0 0.41074-0.09128t0.26622-0.24847q0.10142-0.1572 0.14198-0.36511 0.0431-0.21044 0.0431-0.44624z"/>
        <path d="m-41.877 73.499q0 0.25862-0.09635 0.45385t-0.26115 0.32708q-0.16481 0.12931-0.38539 0.19523-0.22058 0.06593-0.4716 0.06593-0.16988 0-0.31693-0.02789-0.14452-0.02788-0.25608-0.06593-0.11156-0.04057-0.18762-0.08367-0.07353-0.0431-0.10649-0.07606-0.03296-0.03296-0.04817-0.09381-0.01267-0.06339-0.01267-0.18002 0-0.0786 0.0051-0.13184 0.0051-0.05324 0.01522-0.08621 0.01268-0.03296 0.03043-0.04564 0.02028-0.01522 0.04564-0.01522 0.0355 0 0.09888 0.0431 0.06593 0.04057 0.16734 0.09128 0.10142 0.05071 0.24087 0.09381 0.14198 0.04057 0.32707 0.04057 0.1217 0 0.21805-0.02788 0.09635-0.03043 0.16227-0.08367 0.06846-0.05324 0.10395-0.13184 0.0355-0.0786 0.0355-0.17495 0-0.11156-0.06085-0.19016-0.06085-0.08113-0.15974-0.14198-0.09635-0.06339-0.22058-0.11663-0.12424-0.05578-0.25608-0.11663-0.13184-0.06086-0.25608-0.13692-0.12424-0.0786-0.22312-0.18509-0.09635-0.10902-0.1572-0.25608-0.06086-0.14706-0.06086-0.35243 0-0.2358 0.08621-0.41328 0.08874-0.18002 0.2358-0.29665 0.14959-0.11917 0.3499-0.17748 0.20284-0.05831 0.42849-0.05831 0.11663 0 0.23326 0.01775 0.11663 0.01774 0.21805 0.04817 0.10142 0.03043 0.18002 0.06846t0.10395 0.06339q0.02536 0.02536 0.03296 0.0431 0.01014 0.01775 0.01522 0.04817 0.0076 0.02788 0.01014 0.07353 0.0026 0.0431 0.0026 0.10902 0 0.07353-0.0051 0.12424-0.0026 0.05071-0.01268 0.08367-0.0076 0.03296-0.02536 0.04817-0.01522 0.01522-0.0431 0.01522t-0.08874-0.0355q-0.06085-0.0355-0.14959-0.07607-0.08874-0.0431-0.20537-0.07606-0.11663-0.0355-0.25608-0.0355-0.10902 0-0.19016 0.02788-0.08114 0.02536-0.13692 0.07353-0.05324 0.04564-0.08113 0.11156-0.02536 0.06593-0.02536 0.13945 0 0.10902 0.05831 0.19016 0.06085 0.0786 0.15973 0.14199 0.10142 0.06085 0.22819 0.11663 0.12677 0.05324 0.25862 0.1141 0.13184 0.06086 0.25862 0.13945 0.12677 0.07607 0.22566 0.18509 0.09888 0.10649 0.15973 0.25355 0.06085 0.14452 0.06085 0.34229z"/>
        </g>
        <g transform="matrix(.44743 0 0 .49064 -31.766 35.482)" fill="#faa300" stroke-width=".26458" aria-label="Local Log Server">
        <path d="m-14.807 79.101q0 0.10335-0.01033 0.1757-0.01034 0.06718-0.03617 0.11886-0.02067 0.04651-0.05684 0.07235-0.03101 0.02067-0.07752 0.02067h-2.9559q-0.11886 0-0.22738-0.07751-0.10335-0.08268-0.10335-0.28422v-6.1908q0-0.04134 0.02067-0.07235t0.07235-0.04651q0.05168-0.02067 0.13953-0.03101 0.08785-0.0155 0.21187-0.0155 0.12919 0 0.21187 0.0155 0.08785 0.01034 0.13953 0.03101 0.05168 0.0155 0.07235 0.04651t0.02067 0.07235v5.7826h2.3978q0.04651 0 0.07752 0.02584 0.03617 0.02067 0.05684 0.06718 0.02584 0.04134 0.03617 0.11369 0.01033 0.07235 0.01033 0.1757z"/>
        <path d="m-9.5981 76.982q0 0.56844-0.14986 1.049-0.14986 0.47542-0.44958 0.82165-0.29455 0.34623-0.74414 0.5426-0.44442 0.1912-1.0335 0.1912-0.57361 0-1.0025-0.17053-0.42374-0.17053-0.70796-0.49609-0.28422-0.32556-0.42374-0.79065-0.13953-0.46509-0.13953-1.0542 0-0.56844 0.14469-1.0439 0.14986-0.48059 0.44442-0.82682 0.29972-0.34623 0.74414-0.53743 0.44442-0.1912 1.0387-0.1912 0.57361 0 0.99735 0.17053 0.42891 0.17053 0.71313 0.49609 0.28422 0.32556 0.42375 0.79065 0.14469 0.46509 0.14469 1.049zm-0.89917 0.05684q0-0.37724-0.07235-0.71313-0.06718-0.3359-0.22738-0.58911-0.1602-0.25321-0.43408-0.39791-0.27388-0.14986-0.68213-0.14986-0.37724 0-0.65112 0.13436-0.26872 0.13436-0.44442 0.3824-0.1757 0.24288-0.26355 0.57877-0.08268 0.3359-0.08268 0.7338 0 0.3824 0.06718 0.7183 0.07235 0.3359 0.23254 0.58911 0.16536 0.24805 0.43925 0.39791 0.27388 0.14469 0.68213 0.14469 0.37207 0 0.64595-0.13436t0.44958-0.37724q0.1757-0.24288 0.25838-0.57877 0.08268-0.3359 0.08268-0.73897z"/>
        <path d="m-4.9989 78.651q0 0.08785-0.00517 0.15503-0.00517 0.06201-0.020671 0.10852-0.010335 0.04134-0.031006 0.07751-0.015503 0.03101-0.082682 0.09819-0.062012 0.06201-0.21704 0.1602-0.15503 0.09302-0.3514 0.17053-0.1912 0.07235-0.41858 0.11886-0.22738 0.04651-0.47025 0.04651-0.50126 0-0.88883-0.16536t-0.65112-0.48059q-0.25838-0.32039-0.39791-0.78031-0.13436-0.46509-0.13436-1.0697 0-0.68729 0.16536-1.1782 0.17053-0.49609 0.45992-0.81132 0.29455-0.31522 0.68729-0.46509 0.39791-0.15503 0.85783-0.15503 0.22221 0 0.42891 0.04134 0.21187 0.04134 0.38757 0.10852 0.1757 0.06718 0.31006 0.15503 0.13953 0.08785 0.20154 0.14986 0.062011 0.06201 0.082682 0.09819 0.025838 0.03617 0.041341 0.08785 0.015503 0.04651 0.020671 0.10852 0.00517 0.06201 0.00517 0.15503 0 0.20154-0.046509 0.28422-0.046509 0.07751-0.11369 0.07751-0.077514 0-0.18087-0.08268-0.098185-0.08785-0.25321-0.1912-0.15503-0.10335-0.37724-0.18603-0.21704-0.08785-0.51676-0.08785-0.61495 0-0.94568 0.47542-0.32556 0.47025-0.32556 1.3694 0 0.44958 0.082682 0.79065 0.08785 0.3359 0.25321 0.56327 0.16536 0.22738 0.40307 0.34106 0.24288 0.10852 0.55294 0.10852 0.29455 0 0.51676-0.09302 0.22221-0.09302 0.3824-0.20154 0.16536-0.11369 0.27388-0.20154 0.11369-0.09302 0.1757-0.09302 0.036173 0 0.062011 0.02067t0.041341 0.07235q0.02067 0.04651 0.025838 0.12402 0.010335 0.07235 0.010335 0.1757z"/>
        <path d="m-0.45142 79.364q0 0.06201-0.041341 0.09302t-0.11369 0.04651q-0.072347 0.0155-0.21187 0.0155-0.13436 0-0.21704-0.0155-0.077514-0.0155-0.11369-0.04651-0.036173-0.03101-0.036173-0.09302v-0.46509q-0.30489 0.32556-0.68213 0.50643-0.37207 0.18087-0.79065 0.18087-0.3669 0-0.66662-0.09819-0.29455-0.09302-0.50643-0.27388-0.20671-0.18087-0.32556-0.44442-0.11369-0.26355-0.11369-0.59944 0-0.39274 0.1602-0.68213t0.45992-0.48059q0.29972-0.1912 0.7338-0.28422 0.43408-0.09819 0.97668-0.09819h0.64079v-0.36173q0-0.26872-0.056844-0.47542-0.056844-0.20671-0.18603-0.34106-0.12402-0.13953-0.32556-0.2067-0.20154-0.07235-0.49609-0.07235-0.31523 0-0.56844 0.07752-0.24805 0.07235-0.43925 0.16536-0.18603 0.08785-0.31523 0.16536-0.12402 0.07235-0.18603 0.07235-0.041341 0-0.072347-0.02067t-0.056844-0.06201q-0.020671-0.04134-0.031006-0.10335-0.010335-0.06718-0.010335-0.14469 0-0.12919 0.015503-0.20154 0.02067-0.07751 0.08785-0.14469 0.072347-0.06718 0.24288-0.15503 0.17053-0.09302 0.39274-0.16536 0.22221-0.07752 0.48576-0.12402 0.26355-0.05168 0.53227-0.05168 0.50126 0 0.85266 0.11369t0.56844 0.3359q0.21704 0.21704 0.31523 0.5426 0.098185 0.32556 0.098185 0.75964zm-0.84749-2.1239h-0.72864q-0.3514 0-0.60978 0.06201-0.25838 0.05684-0.42891 0.1757-0.17053 0.11369-0.25321 0.27905-0.077514 0.1602-0.077514 0.37207 0 0.36173 0.22738 0.57878 0.23254 0.21187 0.64595 0.21187 0.3359 0 0.62012-0.17053 0.28939-0.17053 0.60461-0.52193z"/>
        <path d="m1.967 79.359q0 0.04134-0.02067 0.07235-0.020671 0.02584-0.067179 0.04651-0.046509 0.02067-0.12919 0.03101-0.082682 0.01033-0.21187 0.01033-0.12402 0-0.20671-0.01033t-0.13436-0.03101q-0.046509-0.02067-0.067179-0.04651-0.015503-0.031-0.015503-0.07235v-6.904q0-0.04134 0.015503-0.07235 0.020671-0.03101 0.067179-0.05168 0.051676-0.02067 0.13436-0.03101 0.082682-0.01033 0.20671-0.01033 0.12919 0 0.21187 0.01033 0.082682 0.01034 0.12919 0.03101 0.046509 0.02067 0.067179 0.05168 0.02067 0.031 0.02067 0.07235z"/>
        <path d="m9.5014 79.101q0 0.10335-0.010335 0.1757-0.010335 0.06718-0.036173 0.11886-0.02067 0.04651-0.056844 0.07235-0.031006 0.02067-0.077514 0.02067h-2.9559q-0.11886 0-0.22738-0.07751-0.10335-0.08268-0.10335-0.28422v-6.1908q0-0.04134 0.02067-0.07235 0.020671-0.03101 0.072347-0.04651 0.051676-0.02067 0.13953-0.03101 0.08785-0.0155 0.21187-0.0155 0.12919 0 0.21187 0.0155 0.08785 0.01034 0.13953 0.03101 0.051676 0.0155 0.072347 0.04651 0.02067 0.03101 0.02067 0.07235v5.7826h2.3978q0.046509 0 0.077514 0.02584 0.036173 0.02067 0.056844 0.06718 0.025838 0.04134 0.036173 0.11369 0.010335 0.07235 0.010335 0.1757z"/>
        <path d="m14.71 76.982q0 0.56844-0.14986 1.049-0.14986 0.47542-0.44958 0.82165-0.29456 0.34623-0.74414 0.5426-0.44442 0.1912-1.0335 0.1912-0.57361 0-1.0025-0.17053-0.42375-0.17053-0.70796-0.49609-0.28422-0.32556-0.42375-0.79065-0.13953-0.46509-0.13953-1.0542 0-0.56844 0.14469-1.0439 0.14986-0.48059 0.44442-0.82682 0.29972-0.34623 0.74414-0.53743 0.44442-0.1912 1.0387-0.1912 0.57361 0 0.99735 0.17053 0.42891 0.17053 0.71313 0.49609 0.28422 0.32556 0.42374 0.79065 0.14469 0.46509 0.14469 1.049zm-0.89917 0.05684q0-0.37724-0.07235-0.71313-0.06718-0.3359-0.22738-0.58911-0.1602-0.25321-0.43408-0.39791-0.27388-0.14986-0.68213-0.14986-0.37724 0-0.65112 0.13436-0.26872 0.13436-0.44442 0.3824-0.1757 0.24288-0.26355 0.57877-0.08268 0.3359-0.08268 0.7338 0 0.3824 0.06718 0.7183 0.07235 0.3359 0.23254 0.58911 0.16536 0.24805 0.43925 0.39791 0.27388 0.14469 0.68213 0.14469 0.37207 0 0.64595-0.13436 0.27388-0.13436 0.44958-0.37724 0.1757-0.24288 0.25838-0.57877 0.08268-0.3359 0.08268-0.73897z"/>
        <path d="m19.852 74.92q0 0.18087-0.05168 0.26355-0.04651 0.07752-0.12402 0.07752h-0.66662q0.18087 0.18603 0.25321 0.41341 0.07235 0.22221 0.07235 0.46509 0 0.40308-0.12919 0.71313-0.12919 0.31006-0.37207 0.5271-0.23771 0.21187-0.56844 0.32556-0.33073 0.11369-0.7338 0.11369-0.28422 0-0.5426-0.07235-0.25321-0.07751-0.39274-0.1912-0.09302 0.09302-0.15503 0.21187-0.05684 0.11886-0.05684 0.27388 0 0.18087 0.16536 0.29972 0.17053 0.11886 0.44958 0.12919l1.2144 0.05168q0.34623 0.01033 0.63562 0.09819 0.28939 0.08268 0.50126 0.24288 0.21187 0.15503 0.33073 0.38757 0.11886 0.22738 0.11886 0.53227 0 0.32039-0.13436 0.60978-0.13436 0.28939-0.41341 0.50643-0.27388 0.22221-0.7028 0.34623-0.42891 0.12919-1.0129 0.12919-0.56327 0-0.96118-0.09819-0.39274-0.09302-0.64595-0.25838-0.25321-0.16536-0.3669-0.39791-0.11369-0.22738-0.11369-0.49609 0-0.17053 0.04134-0.33073 0.04134-0.1602 0.12402-0.30489 0.08785-0.14469 0.21187-0.27388 0.12919-0.13436 0.29455-0.26355-0.25321-0.12919-0.37724-0.32556-0.11886-0.19637-0.11886-0.42375 0-0.31522 0.12919-0.56327 0.12919-0.24805 0.32039-0.44442-0.1602-0.1912-0.25321-0.42891-0.09302-0.24288-0.09302-0.58394 0-0.39791 0.13436-0.71313 0.13436-0.31523 0.37207-0.53227t0.56844-0.33073q0.3359-0.11886 0.72864-0.11886 0.21187 0 0.39274 0.02584 0.18604 0.02067 0.34623 0.06201h1.4056q0.08785 0 0.12919 0.08785 0.04651 0.08268 0.04651 0.25838zm-1.3332 1.2247q0-0.47542-0.26355-0.73897-0.25838-0.26872-0.73897-0.26872-0.24805 0-0.43408 0.08268-0.18087 0.08268-0.30489 0.22738-0.11886 0.14469-0.18087 0.3359-0.05684 0.18603-0.05684 0.39274 0 0.45992 0.25838 0.72347 0.26355 0.26355 0.7338 0.26355 0.25321 0 0.43925-0.07751 0.18603-0.08268 0.30489-0.22221 0.12402-0.14469 0.18087-0.33073 0.06201-0.18604 0.06201-0.38757zm0.42891 3.6845q0-0.29972-0.24805-0.45992-0.24288-0.16536-0.66146-0.1757l-1.2041-0.04134q-0.16536 0.12919-0.27388 0.24805-0.10335 0.11369-0.16536 0.21704-0.06201 0.10852-0.08785 0.21187-0.02067 0.10335-0.02067 0.21187 0 0.3359 0.34106 0.50643 0.34106 0.1757 0.95084 0.1757 0.38757 0 0.64595-0.07751 0.26355-0.07235 0.42375-0.19637 0.1602-0.12402 0.22738-0.28422 0.07235-0.1602 0.07235-0.3359z"/>
        <path d="m27.03 77.613q0 0.47025-0.1757 0.83716-0.17053 0.3669-0.48059 0.62528-0.30489 0.25321-0.72347 0.3824-0.41341 0.12919-0.894 0.12919-0.3359 0-0.62528-0.05684-0.28422-0.05684-0.5116-0.13953-0.22221-0.08268-0.37724-0.17053-0.14986-0.08785-0.21187-0.14986-0.05684-0.06201-0.08785-0.15503-0.02584-0.09818-0.02584-0.25838 0-0.11369 0.01034-0.18603 0.01033-0.07752 0.03101-0.12402 0.02067-0.04651 0.05168-0.06201 0.03101-0.02067 0.07235-0.02067 0.07235 0 0.20154 0.08785 0.13436 0.08785 0.34106 0.1912 0.2067 0.10335 0.49609 0.19637 0.29455 0.08785 0.67696 0.08785 0.28939 0 0.5271-0.07751 0.24288-0.07751 0.41341-0.21704 0.1757-0.14469 0.26872-0.3514 0.09302-0.2067 0.09302-0.47025 0-0.28422-0.12919-0.48576-0.12919-0.20154-0.34106-0.3514-0.21187-0.15503-0.48576-0.27905-0.26872-0.12919-0.55294-0.25838-0.28422-0.13436-0.55294-0.29456-0.26872-0.1602-0.48059-0.37724-0.21187-0.21704-0.34623-0.50643-0.12919-0.29456-0.12919-0.7028 0-0.41858 0.14986-0.74414 0.15503-0.33073 0.42374-0.55294 0.27388-0.22221 0.64595-0.3359 0.37724-0.11886 0.81132-0.11886 0.22221 0 0.44442 0.04134 0.22738 0.03617 0.42374 0.10335 0.20154 0.06201 0.35657 0.14469 0.15503 0.07752 0.20154 0.12919 0.05168 0.04651 0.06718 0.07752 0.0155 0.02584 0.02584 0.07235 0.01034 0.04134 0.0155 0.10335 0.0052 0.06201 0.0052 0.1602 0 0.09302-0.01034 0.16536-0.0052 0.07235-0.02067 0.12402-0.0155 0.04651-0.04651 0.07235-0.02584 0.02067-0.06201 0.02067-0.05684 0-0.18087-0.07235-0.11886-0.07235-0.29456-0.1602-0.1757-0.09302-0.41858-0.16536-0.23771-0.07751-0.53743-0.07751-0.27905 0-0.48576 0.07751-0.2067 0.07235-0.34106 0.19637-0.13436 0.12402-0.20154 0.29456-0.06718 0.17053-0.06718 0.36173 0 0.27905 0.12919 0.48059 0.12919 0.20154 0.34106 0.35657 0.21704 0.15503 0.49092 0.28422 0.27388 0.12919 0.5581 0.26355 0.28422 0.12919 0.5581 0.28939 0.27388 0.15503 0.48576 0.37207 0.21704 0.21187 0.34623 0.50643 0.13436 0.28939 0.13436 0.6873z"/>
        <path d="m32.172 76.832q0 0.20154-0.10335 0.28939-0.09819 0.08268-0.22738 0.08268h-3.0489q0 0.38757 0.07752 0.69763 0.07751 0.31006 0.25838 0.53226 0.18087 0.22221 0.47025 0.34106 0.28939 0.11886 0.70796 0.11886 0.33073 0 0.58911-0.05168 0.25838-0.05684 0.44442-0.12402 0.1912-0.06718 0.31006-0.11886 0.12402-0.05684 0.18603-0.05684 0.03617 0 0.06201 0.02067 0.03101 0.0155 0.04651 0.05168 0.0155 0.03617 0.02067 0.10335 0.01034 0.06201 0.01034 0.15503 0 0.06718-0.0052 0.11886-0.0052 0.04651-0.0155 0.08785-0.0052 0.03617-0.02584 0.06718-0.0155 0.03101-0.04651 0.06201-0.02584 0.02584-0.16536 0.09302-0.13953 0.06201-0.36173 0.12402-0.22221 0.06201-0.51676 0.10852-0.28939 0.05168-0.62012 0.05168-0.57361 0-1.0077-0.1602-0.42891-0.1602-0.72347-0.47542-0.29455-0.31522-0.44442-0.79065-0.14986-0.47542-0.14986-1.1059 0-0.59944 0.15503-1.0749 0.15503-0.48059 0.44442-0.81132 0.29456-0.3359 0.70796-0.5116 0.41341-0.18087 0.925-0.18087 0.54777 0 0.93017 0.1757 0.38757 0.1757 0.63562 0.47542 0.24805 0.29456 0.36173 0.69763 0.11886 0.39791 0.11886 0.85266zm-0.85783-0.25321q0.0155-0.67179-0.29972-1.0542-0.31006-0.3824-0.925-0.3824-0.31523 0-0.55294 0.11886-0.23771 0.11886-0.39791 0.31522-0.1602 0.19637-0.24805 0.45992-0.08785 0.25838-0.09819 0.5426z"/>
        <path d="m36.187 75.013q0 0.11369-0.0052 0.1912-0.0052 0.07751-0.02067 0.12402-0.0155 0.04134-0.04134 0.06718-0.02067 0.02067-0.06201 0.02067t-0.10335-0.02067q-0.05684-0.02584-0.13436-0.04651-0.07235-0.02584-0.16536-0.04651-0.09302-0.02067-0.20154-0.02067-0.12919 0-0.25321 0.05168t-0.26355 0.17053q-0.13436 0.11886-0.28422 0.31522t-0.33073 0.48059v3.0592q0 0.04134-0.02067 0.07235-0.02067 0.02584-0.06718 0.04651t-0.12919 0.03101q-0.08268 0.01033-0.21187 0.01033-0.12402 0-0.2067-0.01033-0.08268-0.01033-0.13436-0.03101-0.04651-0.02067-0.06718-0.04651-0.0155-0.031-0.0155-0.07235v-4.6509q0-0.04134 0.0155-0.06718 0.0155-0.03101 0.06201-0.05168 0.04651-0.02584 0.11886-0.03101 0.07235-0.01033 0.1912-0.01033 0.11369 0 0.18603 0.01033 0.07751 0.0052 0.11886 0.03101 0.04134 0.02067 0.05684 0.05168 0.02067 0.02584 0.02067 0.06718v0.67696q0.1912-0.27905 0.35657-0.45475 0.17053-0.1757 0.32039-0.27388 0.14986-0.10335 0.29456-0.13953 0.14986-0.04134 0.29972-0.04134 0.06718 0 0.14986 0.01034 0.08785 0.0052 0.18087 0.02584 0.09302 0.02067 0.16536 0.04651 0.07751 0.02584 0.10852 0.05168 0.03101 0.02584 0.04134 0.05168 0.01033 0.02067 0.0155 0.05684 0.01033 0.03617 0.01033 0.10852 0.0052 0.06718 0.0052 0.18604z"/>
        <path d="m41.07 74.698q0 0.02067-0.0052 0.04651 0 0.02067-0.0052 0.04651t-0.0155 0.05684q-0.0052 0.03101-0.0155 0.06718l-1.5865 4.4183q-0.02067 0.05684-0.05684 0.09302-0.03101 0.03617-0.09818 0.05684-0.06718 0.02067-0.17053 0.02584-0.10335 0.01033-0.25838 0.01033-0.15503 0-0.25838-0.01033-0.10335-0.01033-0.17053-0.03101-0.06201-0.02067-0.09818-0.05684t-0.05684-0.08785l-1.5813-4.4183q-0.02067-0.06201-0.03617-0.10852-0.01034-0.04651-0.0155-0.06718 0-0.02584 0-0.04134 0-0.04134 0.02067-0.07235t0.06718-0.04651q0.05168-0.02067 0.12919-0.02584 0.08268-0.0052 0.20154-0.0052 0.14986 0 0.23771 0.01033 0.09302 0.0052 0.13953 0.02584 0.05168 0.02067 0.07235 0.05168 0.02584 0.03101 0.04651 0.07751l1.3126 3.8344 0.02067 0.06201 0.0155-0.06201 1.2971-3.8344q0.01034-0.04651 0.03617-0.07751 0.02584-0.03101 0.07235-0.05168 0.05168-0.02067 0.13436-0.02584 0.08785-0.01033 0.22738-0.01033 0.11886 0 0.19637 0.0052 0.07751 0.0052 0.11886 0.02584 0.04651 0.02067 0.06201 0.05168 0.02067 0.02584 0.02067 0.06718z"/>
        <path d="m45.902 76.832q0 0.20154-0.10335 0.28939-0.09818 0.08268-0.22738 0.08268h-3.0489q0 0.38757 0.07751 0.69763 0.07752 0.31006 0.25838 0.53226 0.18087 0.22221 0.47025 0.34106 0.28939 0.11886 0.70796 0.11886 0.33073 0 0.58911-0.05168 0.25838-0.05684 0.44442-0.12402 0.1912-0.06718 0.31006-0.11886 0.12402-0.05684 0.18603-0.05684 0.03617 0 0.06201 0.02067 0.03101 0.0155 0.04651 0.05168 0.0155 0.03617 0.02067 0.10335 0.01033 0.06201 0.01033 0.15503 0 0.06718-0.0052 0.11886-0.0052 0.04651-0.0155 0.08785-0.0052 0.03617-0.02584 0.06718-0.0155 0.03101-0.04651 0.06201-0.02584 0.02584-0.16536 0.09302-0.13953 0.06201-0.36173 0.12402-0.22221 0.06201-0.51676 0.10852-0.28939 0.05168-0.62012 0.05168-0.57361 0-1.0077-0.1602-0.42891-0.1602-0.72347-0.47542t-0.44442-0.79065q-0.14986-0.47542-0.14986-1.1059 0-0.59944 0.15503-1.0749 0.15503-0.48059 0.44442-0.81132 0.29455-0.3359 0.70796-0.5116 0.41341-0.18087 0.925-0.18087 0.54777 0 0.93017 0.1757 0.38757 0.1757 0.63562 0.47542 0.24805 0.29456 0.36173 0.69763 0.11886 0.39791 0.11886 0.85266zm-0.85783-0.25321q0.0155-0.67179-0.29972-1.0542-0.31006-0.3824-0.92501-0.3824-0.31522 0-0.55294 0.11886-0.23771 0.11886-0.39791 0.31522-0.1602 0.19637-0.24805 0.45992-0.08785 0.25838-0.09819 0.5426z"/>
        <path d="m49.917 75.013q0 0.11369-0.0052 0.1912-0.0052 0.07751-0.02067 0.12402-0.0155 0.04134-0.04134 0.06718-0.02067 0.02067-0.06201 0.02067t-0.10335-0.02067q-0.05684-0.02584-0.13436-0.04651-0.07235-0.02584-0.16536-0.04651-0.09302-0.02067-0.20154-0.02067-0.12919 0-0.25321 0.05168t-0.26355 0.17053q-0.13436 0.11886-0.28422 0.31522t-0.33073 0.48059v3.0592q0 0.04134-0.02067 0.07235-0.02067 0.02584-0.06718 0.04651t-0.12919 0.03101q-0.08268 0.01033-0.21187 0.01033-0.12402 0-0.2067-0.01033-0.08268-0.01033-0.13436-0.03101-0.04651-0.02067-0.06718-0.04651-0.0155-0.031-0.0155-0.07235v-4.6509q0-0.04134 0.0155-0.06718 0.0155-0.03101 0.06201-0.05168 0.04651-0.02584 0.11886-0.03101 0.07235-0.01033 0.1912-0.01033 0.11369 0 0.18603 0.01033 0.07751 0.0052 0.11886 0.03101 0.04134 0.02067 0.05684 0.05168 0.02067 0.02584 0.02067 0.06718v0.67696q0.1912-0.27905 0.35657-0.45475 0.17053-0.1757 0.32039-0.27388 0.14986-0.10335 0.29456-0.13953 0.14986-0.04134 0.29972-0.04134 0.06718 0 0.14986 0.01034 0.08785 0.0052 0.18087 0.02584 0.09302 0.02067 0.16536 0.04651 0.07751 0.02584 0.10852 0.05168 0.03101 0.02584 0.04134 0.05168 0.01033 0.02067 0.0155 0.05684 0.01034 0.03617 0.01034 0.10852 0.0052 0.06718 0.0052 0.18604z"/>
        </g>
      </g>
      </svg>
      <sup><small><a href="https://github.com/totakaro/nhos-llserver/releases" target="_blank" id="version">v${VERSION}</a> ⚡ <a href="https://totakaro.github.io/donate" target="_blank">Donate</a></small></small></sup>
      <button id="rigs-all">Rigs</button> <button id="rig-add">Add rig</button>
      <button id="top">Go Top</button>
      <button id="bottom">Go Bottom</button>
      <button id="clear">Clear tab logs</button>
      <button id="reboot">Reboot rig</button>
      <button id="config" class="open">Config</button> <button id="config-save" class="remove">Save Config</button>
      <button id="oc" class="open">OC Settings</button> <button id="oc-save" class="remove">Save OC</button>
      <span id="tools-checks"><input type="checkbox" name="autoscroll" id="autoscroll" checked=""> <label for="autoscroll">AutoScroll?</label>
      <input type="checkbox" name="color" id="color" checked=""> <label for="color">Color?</label></span>
    </div>
    <div id="rigs-list-title">Rigs</div>
    <div id="rigs-list"></div>
    <div id="rig-info-title">Basic Rig Infomation</div>
    <pre id="rig-info"></pre>
    <label for="config" id="config-title">Configuration file</label>
    <div id="config-gui">
    </div>
    <textarea id="config-txt" style="display: none;" spellcheck="false"></textarea>
    <label for="oc-settings" id="oc-title">OC Settings</label>
    <div id="oc-settings-gui">
    </div>
    <textarea id="oc-settings" style="display: none;" spellcheck="false"></textarea>
    <div id="logs-title">Miners Logs</div>
    <pre id="logs"></pre>
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.0.0/ansi_up.js"
      integrity="sha256-hvLefrSZwtORL7LIUdbClzIqvJ3UW3kutOrxlWL300s=" crossorigin="anonymous"></script>
    <script>
  (function(){
      // Vars
      var logo = document.getElementById("logo")
      var autoscroll = document.getElementById("autoscroll")
      var bottom = document.getElementById("bottom")
      var clear = document.getElementById("clear")
      var color = document.getElementById("color")
      var rigInfoTitle = document.getElementById("rig-info-title")
      var rigInfo = document.getElementById("rig-info")
      var logs = document.getElementById("logs")
      var logsTitle = document.getElementById("logs-title")
      var oc = document.getElementById("oc")
      var ocSave = document.getElementById("oc-save")
      var ocSettings = document.getElementById("oc-settings")
      var ocSettingsGui = document.getElementById("oc-settings-gui")
      var ocTitle = document.getElementById("oc-title")
      var configSave = document.getElementById("config-save")
      var config = document.getElementById("config")
      var configTxt = document.getElementById("config-txt")
      var configGui = document.getElementById("config-gui")
      var configTitle = document.getElementById("config-title")
      var reboot = document.getElementById("reboot")
      var top_ = document.getElementById("top")
      var tools = document.getElementById("tools")
      var version = document.getElementById("version")
      var rigsAll = document.getElementById("rigs-all")
      var rigAdd = document.getElementById("rig-add")
      var rigsList = document.getElementById("rigs-list")
      var rigsListTitle = document.getElementById("rigs-list-title")
      var toolsChecks = document.getElementById("tools-checks")
      var protocol = window.location.protocol + "//"

      if (protocol === "https://") {
        rigsListTitle.insertAdjacentHTML("beforeend", ": <small>Only https online</small>")
      }

      logo.addEventListener("click", function() {
        location.reload()
      })

      var eventSource
      var rig = {
        url: ""
      }

      var rigs = localStorage.getItem("rigs")
      if (rigs) {
        rigs = JSON.parse(rigs)
      } else {
        rigs = {"list": [window.location.host]}
      }

      // Polyfill if no AnsiUp 3rd party available
      if (typeof AnsiUp === "undefined") {
        AnsiUp = function () { }
        // Remove color tags because no AnsiUp available
        AnsiUp.prototype.ansi_to_html = function (data) {
          return data.replace(/.\[(\d+;)?\d+m/g, "")
        }
        // Disable color because no AnsiUp available
        color.checked = false
        color.addEventListener("click", function (e) {
          e.preventDefault()
          alert("This feature requires the 3rd party library ansi_up.js")
        })
      }

      var ansi_up = new AnsiUp

      // Calculate top_ margin for fixed tools bar
      rigInfoTitle.style.marginTop = tools.offsetHeight + "px"
      rigsListTitle.style.marginTop = tools.offsetHeight + "px"

      // Change color status
      color.addEventListener("change", function () {
        if (color.checked) {
          document.styleSheets[0].deleteRule(0)
        } else {
          document.styleSheets[0].insertRule("#logs span, #rig-info span { color: lightgray !important;}", 0)
        }
      })

      // All inputs from ${DEVICE_SETTINGS_JSON}
      function guiOCSetup(element) {
        var json = JSON.parse(element.value)
        if (json["detected_devices"].length === 0) {
          ocSettingsGui.insertAdjacentText("beforeend", "No devices found, wait for NHOS to generate ${DEVICE_SETTINGS_JSON} and try reopen OC settings again.")
          return
        }
        let counter = 0
        json["detected_devices"].forEach(function (device) {
          ocSettingsGui.insertAdjacentText("beforeend", "Device: " + device["name"] + " " + device["device_id"])
          ocSettingsGui.insertAdjacentHTML("beforeend", "<br>")
          device["algorithms"].forEach(function (algo) {
            counter++
            ocSettingsGui.insertAdjacentHTML("beforeend", "Miner: " + algo["miner"] + " on power modes low, medium and high. ")
            ocSettingsGui.insertAdjacentHTML("beforeend", "<label for=\"checkbox" + counter + "\">All same? </label> <input type=\"checkbox\" id=\"checkbox" + counter + "\" class=\"samecheck\"><br>")
            let checkbox = document.getElementById("checkbox" + counter)
            algo["power"].forEach(function (mode) {
              let label0, label1, label2, range0, range1, range2, number0, number1, number2
              label0 = document.createElement("label")
              label1 = document.createElement("label")
              label2 = document.createElement("label")
              range0 = document.createElement("input")
              range1 = document.createElement("input")
              range2 = document.createElement("input")
              number0 = document.createElement("input")
              number1 = document.createElement("input")
              number2 = document.createElement("input")
              range0.max = 100
              range0.min = 0
              range0.step = 1
              range1.max = 5000
              range1.min = -5000
              range1.step = 1
              range2.max = 5000
              range2.min = -5000
              range2.step = 1
              number0.max = 100
              number0.min = 0
              number0.step = 1
              number1.max = 5000
              number1.min = -5000
              number1.step = 1
              number2.max = 5000
              number2.min = -5000
              number2.step = 1
              range0.type = "range"
              range1.type = "range"
              range2.type = "range"
              number0.type = "number"
              number1.type = "number"
              number2.type = "number"
              if (mode["tdp"] != "default") {
                range0.value = mode["tdp"]
                number0.value = range0.value
              }
              if (mode["core_clocks"] != "default") {
                range1.value = mode["core_clocks"]
                number1.value = range1.value
              }
              if (mode["memory_clocks"] != "default") {
                range2.value = mode["memory_clocks"]
                number2.value = range2.value
              }
              label0.textContent = "TDP "
              label1.textContent = "CORE "
              label2.textContent = "MEMORY "
              if (mode["mode"] !== "low") {
                range0.classList.add("not-low-" + counter)
                range1.classList.add("not-low-" + counter)
                range2.classList.add("not-low-" + counter)
                number0.classList.add("not-low-" + counter)
                number1.classList.add("not-low-" + counter)
                number2.classList.add("not-low-" + counter)
                range0.classList.add("tdp-" + counter)
                number0.classList.add("tdp-" + counter)
                range1.classList.add("core-clocks-" + counter)
                number1.classList.add("core-clocks-" + counter)
                range2.classList.add("memory-clocks-" + counter)
                number2.classList.add("memory-clocks-" + counter)
              }
              ocSettingsGui.appendChild(label0)
              ocSettingsGui.appendChild(number0)
              ocSettingsGui.appendChild(range0)
              ocSettingsGui.appendChild(label1)
              ocSettingsGui.appendChild(number1)
              ocSettingsGui.appendChild(range1)
              ocSettingsGui.appendChild(label2)
              ocSettingsGui.appendChild(number2)
              ocSettingsGui.appendChild(range2)
              ocSettingsGui.insertAdjacentHTML("beforeend", "<br>")

              let updateJson = function(currentEl, bindElement, inputType, selector) {
                bindElement.value = currentEl.value
                mode[inputType] = parseInt(currentEl.value)
                element.value = JSON.stringify(json, null, "\t")
                if (mode["mode"] === "low" && checkbox.checked) {
                  document.querySelectorAll(selector).forEach(function(sel) {
                    sel.value = currentEl.value
                    sel.dispatchEvent(new CustomEvent("update", { bubbles: true, detail: { inputType: inputType, value: sel.value } }))
                    element.value = JSON.stringify(json, null, "\t")
                  })
                }
              }

              let inputs = [range0, number0,  range1, number1, range2 , number2], inputCounter = 0
              inputs.forEach(function (input) {
                input.addEventListener("update", function(e) {
                  mode[e.detail.inputType] = parseInt(e.detail.value)
                })
                let ic = ++inputCounter
                let c = counter
                input.addEventListener("input", function (e) {
                  let index = (ic % 2 == 0) ? ic - 2 : ic
                  let type, selector
                  if (ic <= 2) {
                    type = "tdp"
                    selector = ".tdp-" + c
                  } else if (ic <= 4) {
                    type = "core_clocks"
                    selector = ".core-clocks-" + c
                  } else {
                    type = "memory_clocks"
                    selector = ".memory-clocks-" + c
                  }
                  updateJson(input, inputs[index], type, selector)
                })
              })
            })
          })
        })
        let checkboxes = document.querySelectorAll(".samecheck")
        let eventCounter = 0
        checkboxes.forEach(function(checkbox) {
          let ec = ++eventCounter
          let notLow = document.querySelectorAll(".not-low-" + ec)
          checkbox.addEventListener("click", function () {
            //localStorage.setItem("checkbox" +  ec, checkbox.checked)
            notLow.forEach(function(el) {
              if (checkbox.checked) {
                el.setAttribute("disabled", "disabled")
              } else {
                el.removeAttribute("disabled");
              }
            })
          })
        })
      }

      // All inputs from ${CONFIGURATION_TXT}
      function guiConfig(element) {
        var json = JSON.parse(element.value), fanDefaults
        if (json["fan_control"] === undefined) {
          fanDefaults = [
            {tmpc: 40, spdp: 25},
            {tmpc: 45, spdp: 35},
            {tmpc: 50, spdp: 40},
            {tmpc: 55, spdp: 50},
            {tmpc: 60, spdp: 60},
            {tmpc: 65, spdp: 70},
            {tmpc: 70, spdp: 75},
            {tmpc: 75, spdp: 80},
            {tmpc: 80, spdp: 85},
            {tmpc: 85, spdp: 95},
            {tmpc: 90, spdp: 100}
          ]
          json["fan_control"] = fanDefaults
        }
        let counter = 0
        configGui.insertAdjacentText("beforeend", "Global Fan states")
        configGui.insertAdjacentHTML("beforeend", "<br>")
        configGui.insertAdjacentText("beforeend", "Temperature - Speed %")
        configGui.insertAdjacentHTML("beforeend", "<br>")
        json["fan_control"].forEach(function (state) {
          let tmpc = document.createElement("input")
          let spdp = document.createElement("input")
          let spdpmeter = document.createElement("input")
          tmpc.max = 100
          tmpc.min = 0
          tmpc.step = 1
          tmpc.type = "number"
          tmpc.value = state.tmpc
          spdp.max = 100
          spdp.min = 0
          spdp.step = 1
          spdp.type = "number"
          spdp.value = state.spdp
          spdpmeter.max = 100
          spdpmeter.min = 0
          spdpmeter.step = 1
          spdpmeter.type = "range"
          spdpmeter.value = state.spdp
          configGui.appendChild(tmpc)
          configGui.insertAdjacentText("beforeend", " - ")
          configGui.appendChild(spdp)
          configGui.appendChild(spdpmeter)
          configGui.insertAdjacentHTML("beforeend", " State " + counter + "<br>")
          counter++
          tmpc.addEventListener("input", function() {
            state.tmpc = parseInt(tmpc.value)
            element.value = JSON.stringify(json, null, "    ")
          })
          spdp.addEventListener("input", function() {
            spdpmeter.value = spdp.value
            state.spdp = parseInt(spdp.value)
            element.value = JSON.stringify(json, null, "    ")
          })
          spdpmeter.addEventListener("input", function() {
            spdp.value = spdpmeter.value
            state.spdp = parseInt(spdp.value)
            element.value = JSON.stringify(json, null, "    ")
          })
        })
      }

      // Open ${CONFIGURATION_TXT}
      config.addEventListener("click", function () {
        if (configTxt.style.display === "none") {
          fetch(rig.url + "/${CONFIGURATION_TXT}")
            .then(function (response) {
              return response.json()
            })
            .then(function (json) {
              config.textContent = "Close Config"
              configTitle.style.display = "block"
              configSave.style.display = "inline-block"
              oc.style.display = "none"
              autoscroll.checked = false
              top_.click()
              configTxt.value = JSON.stringify(json, null, "    ")
              configTxt.style.display = "block"
              configGui.style.display = "block"
              guiConfig(configTxt)
            })
            .catch(function (error) {
              alert("Error comunicating with local server. " + error)
            })
        } else {
          oc.style.display = "inline-block"
          configGui.textContent = ""
          configGui.style.display = "none"
          config.textContent = "Config"
          autoscroll.checked = true
          configTitle.style.display = "none"
          configSave.style.display = "none"
          configTxt.style.display = "none"
        }
      })

      // Save ${CONFIGURATION_TXT}
      configSave.addEventListener("click", function () {
        try {
          JSON.parse(configTxt.value)
        } catch (err) {
          alert("Error in your ${CONFIGURATION_TXT}, please check again: " + err)
          return
        }
        if (!confirm("Please backup your configuration before save it.\nAre you sure to continue?")) {
          return
        }
        fetch(rig.url + "/${CONFIGURATION_TXT}", { method: "POST", body: configTxt.value + "\n" })
          .then(function (response) {
            return response.text()
          })
          .then(function (text) {
            alert("Configuration saved successfully! New Fan control executed! You may need to reboot to apply remaining changes.")
            rigOpenSetup()
          })
          .catch(function (error) {
            alert("Error saving ${CONFIGURATION_TXT} in local server, reboot probably in progress. " + error)
          })
      })

      // Move to top_
      top_.addEventListener("click", function () {
        autoscroll.checked = false
        window.scrollTo(0, 0)
      })

      // Move to bottom
      bottom.addEventListener("click", function () {
        autoscroll.checked = true
        window.scrollTo(0, document.body.scrollHeight)
      })

      // Clear current logs and loads new ones
      clear.addEventListener("click", function () {
        if (confirm("Are you sure to clear logs in this tab?")) {
          logs.textContent = ""
        }
      })

      // Rig reboot
      reboot.addEventListener("click", function () {
        if (confirm("Are you sure to reboot your rig?")) {
          fetch(rig.url + "/reboot", { method: "POST" })
            .then(function (response) {
              return response.text()
            })
            .then(function (text) {
              alert("Reboot request executed! " + text)
            })
            .catch(function (error) {
              alert("Error comunicating with local server, reboot probably in progress. " + error)
            })
        }
      })

      // Show or Close OC Settings
      oc.addEventListener("click", function () {
        if (ocSettings.style.display === "none") {
          if (!confirm("CAUTION:\nOC can damage your hardware!\nEdit only if you know what you are doing!\nDo you wanna continue?")) {
            return
          }
          fetch(rig.url + "/${DEVICE_SETTINGS_JSON}")
            .then(function (response) {
              return response.json()
            })
            .then(function (json) {
              oc.textContent = "Close OC Settings"
              ocTitle.style.display = "block"
              ocSave.style.display = "inline-block"
              config.style.display = "none"
              autoscroll.checked = false
              top_.click()
              ocSettings.value = JSON.stringify(json, null, "\t")
              ocSettings.style.display = "block"
              ocSettingsGui.style.display = "block"
              guiOCSetup(ocSettings)
            })
            .catch(function (error) {
              alert("Error comunicating with local server. " + error)
            })
        } else {
          config.style.display = "inline-block"
          ocSettingsGui.textContent = ""
          ocSettingsGui.style.display = "none"
          oc.textContent = "OC Settings"
          autoscroll.checked = true
          ocTitle.style.display = "none"
          ocSave.style.display = "none"
          ocSettings.style.display = "none"
        }
      })

      // Save OC Settings
      ocSave.addEventListener("click", function () {
        try {
          JSON.parse(ocSettings.value)
        } catch (err) {
          alert("Error in your OC Settings, please check again: " + err)
          return
        }
        if (!confirm("Please backup your OC settings before save them.\nAre you sure to continue?")) {
          return
        }
        fetch(rig.url + "/${DEVICE_SETTINGS_JSON}", { method: "POST", body: ocSettings.value + "\n" })
          .then(function (response) {
            return response.text()
          })
          .then(function (text) {
            alert("OC Settings saved successfully!")
            rigOpenSetup(10000)
          })
          .catch(function (error) {
            alert("Error saving OC settings in local server. " + error)
          })
      })

      // Open a specific rig and get basic rig information
      function rigOpen(ip) {
        fetch(protocol + ip + "/${NHM_TXT}")
          .then(function (response) {
              if (response.ok) {
                rig.url = protocol + ip
                localStorage.setItem("rigSelectedIp", ip.trim())
                rigInfo.textContent = ""
                rigOpenSetup()
                return response.text()
              } else {
                throw "Trying to fetch rig failed"
              }
          })
          .then(function (text) {
            rigInfo.insertAdjacentHTML("beforeend", ansi_up.ansi_to_html(text))
          })
          .catch(function (error) {
            rigInfo.insertAdjacentText("beforeend", error)
          })
      }

      //Setup opened rig
      function rigOpenSetup(timeout) {
        config.textContent = "Config"
        config.style.display = "inline-block"
        oc.textContent = "OC Settings"
        oc.style.display = "inline-block"
        ocSave.style.display = "none"
        ocSettingsGui.textContent = ""
        ocSettingsGui.style.display = "none"
        ocSettings.style.display = "none"
        ocSave.style.display = "none"
        ocTitle.style.display = "none"
        config.textContent = "Config"
        configGui.textContent = ""
        configGui.style.display = "none"
        configTxt.style.display = "none"
        configSave.style.display = "none"
        configTitle.style.display = "none"
        autoscroll.checked = true
        rigInfo.style.display = "block"
        rigInfoTitle.style.display = "block"
        rigsAll.style.display = "inline-block"
        logs.style.display = "block"
        logsTitle.style.display = "block"
        top_.style.display = "inline-block"
        bottom.style.display = "inline-block"
        clear.style.display = "inline-block"
        reboot.style.display = "inline-block"
        toolsChecks.style.display = "inline-block"
        rigAdd.style.display = "none"
        rigsList.style.display = "none"
        rigsListTitle.style.display = "none"

        loadLogs(timeout)
      }

      function loadLogs(timeout) {
        // Scroll down to see latest logs
        if (autoscroll.checked) {
          window.scrollTo(0, document.body.scrollHeight)
        }

        let dots, loading, line_color
        if (eventSource) {
          // Clear previous events
          eventSource.close()
          // Loading dots
          loading = setTimeout(function() {
            logs.insertAdjacentHTML("beforeend", "<br>")
            logs.insertAdjacentText("beforeend", "Loading")
            if (autoscroll.checked) {
              window.scrollTo(0, document.body.scrollHeight)
            }
            dots = setInterval(function () {
              logs.insertAdjacentText("beforeend", ".")
            }, 500)
          }, 1000)
        }


        // Add optional timeout before request logs files
        setTimeout(function() {

          // Connects to Server Sent Events
          eventSource = new EventSource(rig.url + "/miners-logs")
          eventSource.onmessage = function (e) {
            // Stop loading dots
            clearInterval(loading)
            clearInterval(dots)
            // Limit logs history to 1000 lines
            while (logs.childElementCount > 1000) {
              logs.removeChild(logs.firstChild)
            }
            setTimeout(function () {
              logs.insertAdjacentHTML("beforeend", "<br>")
              // Changes line_color according to thermal slowdown status for nvidia cards
              if (e.data.includes("SW Thermal Slowdown")) {
                if (e.data.includes(": Active")) {
                  line_color = "\033[0;31m" // Red
                } else {
                  line_color = "\033[0;32m" // Green
                }
              } else {
                line_color = "\033[0m" // Reset no color
              }
              logs.insertAdjacentHTML("beforeend", ansi_up.ansi_to_html(line_color + e.data + "\033[0m"))
              // AutoScroll if enabled
              if (autoscroll.checked) {
                window.scrollTo(0, document.body.scrollHeight)
              }
            }, 100)
          }
        }, timeout)
      }

      // Gets current version and compares it with the latest version
      fetch("https://api.github.com/repos/totakaro/nhos-llserver/releases/latest")
        .then(function (response) { return response.json() }).then(function (json) {
          let currentVersion = json["tag_name"]
          version
          if (version.textContent !== currentVersion) {
            version.insertAdjacentText("beforeend", " (Latest is " + currentVersion + ")")
          }
        })

      // Calculate time since https://stackoverflow.com/a/3177838
      function timeSince(date) {
        var seconds = Math.abs(Math.floor((new Date() - date) / 1000)), fullUptime = ""
        var interval = seconds / 31536000
        if (interval > 1) {
          fullUptime = fullUptime +  Math.floor(interval) + " years "
          seconds = seconds - Math.floor(interval) * 31536000
        }
        interval = seconds / 2592000
        if (interval > 1) {
          fullUptime = fullUptime +  Math.floor(interval) + " months "
          seconds = seconds - Math.floor(interval) * 2592000
        }
        interval = seconds / 86400
        if (interval > 1) {
          fullUptime = fullUptime +  Math.floor(interval) + " days "
          seconds = seconds - Math.floor(interval) * 86400
        }
        interval = seconds / 3600
        if (interval > 1) {
          fullUptime = fullUptime +  Math.floor(interval) + " hours "
          seconds = seconds - Math.floor(interval) * 3600
        }
        interval = seconds / 60
        if (interval > 1) {
          fullUptime = fullUptime +  Math.floor(interval) + " minutes "
          seconds = seconds - Math.floor(interval) * 60
        }
        fullUptime = fullUptime +  Math.floor(seconds) + " seconds"
        return fullUptime
      }

      // Adds rig to the rigs list gui
      function rigAddGui(ip) {
        let rigItem = document.createElement("div")
        let rigItemActions = document.createElement("div")
        let rigItemIp = document.createElement("span")
        let rigOpenButton = document.createElement("button")
        let rigRemoveButton = document.createElement("button")
        rigItemIp.classList.add("rig-item-ip")
        rigItemActions.classList.add("rig-item-actions")
        rigItem.classList.add("rig-item")
        rigRemoveButton.style.marginLeft= "10px"
        rigOpenButton.textContent = "Open"
        rigOpenButton.classList.add("open")
        rigRemoveButton.textContent = "Remove"
        rigRemoveButton.classList.add("remove")
        if (ip === window.location.host) {
          rigRemoveButton.classList.add("disabled")
          rigRemoveButton.disabled = true
        }
        rigItemIp.insertAdjacentText("beforeend", "address '" +  ip + "'")
        rigItemIp.insertAdjacentHTML("beforeend", "<br>")
        rigItem.classList.add("offline")
        rigOpenButton.classList.add("disabled")
        rigOpenButton.disabled = true
        fetch(protocol + ip + "/${NHM_TXT}")
          .then(function (response) {
            if (response.ok) {
              return response.text()
            } else {
              throw "Trying to fetch rig failed"
            }
          })
          .then(function (text) {
            rigItem.classList.remove("offline")
            rigOpenButton.classList.remove("disabled")
            rigItem.classList.add("online")
            rigOpenButton.disabled = false
            let username = text.substring(text.lastIndexOf("username '") + 9, text.lastIndexOf(" worker"))
            let worker = text.substring(text.lastIndexOf("worker '") + 7, text.lastIndexOf(" group"))
            let group = text.substring(text.lastIndexOf("group '") + 6, text.lastIndexOf(" miningLocation"))
            let miningLocation = text.substring(text.lastIndexOf("miningLocation '") + 15, text.lastIndexOf(" platformVersion"))
            let platformVersion = text.substring(text.lastIndexOf("platformVersion '") + 16, text.lastIndexOf("'") + 1)
            let date = text.substring(text.lastIndexOf("[2") + 1, text.lastIndexOf("]"))
            rigItemIp.insertAdjacentText("beforeend", "status 'online'")
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "worker " +  worker)
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "group " + group)
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "username " +  username)
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "miningLocation " + miningLocation)
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "platformVersion " + platformVersion)
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "uptime '" + timeSince(new Date(date)) + "'")
          })
          .catch(function (error) {
            rigItemIp.insertAdjacentText("beforeend", "status 'offline'")
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "worker ''" )
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "group ''")
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "username ''" )
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "miningLocation ''")
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "platformVersion ''")
            rigItemIp.insertAdjacentHTML("beforeend", "<br>")
            rigItemIp.insertAdjacentText("beforeend", "uptime ''")
          })
        rigItem.appendChild(rigItemIp)
        rigItemActions.appendChild(rigOpenButton)
        rigItemActions.appendChild(rigRemoveButton)
        rigItem.appendChild(rigItemActions)
        rigsList.appendChild(rigItem)
        fetch(protocol + window.location.host + "/${RIGS_JSON}", { method: "POST", body: JSON.stringify(rigs, false, "\t") + "\n"})
        localStorage.setItem("rigs", JSON.stringify(rigs))
        rigRemoveButton.addEventListener("click", function() {
          if(confirm("Are you sure to remove this rig from the list?")) {
            rigItem.parentNode.removeChild(rigItem)
            rigs.list = rigs.list.filter(function(item) {
                return item !== ip
            })
            fetch(protocol + window.location.host + "/${RIGS_JSON}", { method: "POST", body: JSON.stringify(rigs, false, "\t") + "\n"})
            localStorage.setItem("rigs", JSON.stringify(rigs))
          }
        })
        rigOpenButton.addEventListener("click", function() {
          rigOpen(ip)
        })
      }

      // List all rigs
      rigsAll.addEventListener("click", function() {
        localStorage.removeItem("rigSelectedIp")
        ocSettingsGui.textContent = ""
        ocSettingsGui.style.display = "none"
        ocSettings.style.display = "none"
        oc.textContent = "OC Settings"
        ocSave.style.display = "none"
        ocTitle.style.display = "none"
        oc.style.display = "none"
        configGui.textContent = ""
        configGui.style.display = "none"
        configTxt.style.display = "none"
        config.textContent = "Config"
        configSave.style.display = "none"
        configTitle.style.display = "none"
        config.style.display = "none"
        rigsListTitle.style.display = "block"
        rigsList.style.display = "block"
        logs.textContent = ""
        rigInfo.textContent = ""
        autoscroll.checked = true
        logs.style.display = "none"
        logsTitle.style.display = "none"
        rigInfo.style.display = "none"
        rigInfoTitle.style.display = "none"
        rigsAll.style.display = "none"
        top_.style.display = "none"
        bottom.style.display = "none"
        clear.style.display = "none"
        reboot.style.display = "none"
        toolsChecks.style.display = "none"
        rigAdd.style.display = "inline-block"
        // Clear previous events
        if (eventSource) {
          eventSource.close()
        }
      })

      // Add new rig to the list
      rigAdd.addEventListener("click", function() {
        let ip = prompt("Add your rig address:")
        if (ip) {
          ip = ip.replace(/(^\w+:|^)\/\//, '').replace(/\/$/, '')
          if (rigs.list.indexOf(ip) === -1) {
            rigs.list.push(ip.trim())
            rigAddGui(ip)
          }
        }
      })

      // Check rigs
      fetch(protocol + window.location.host + "/${RIGS_JSON}")
        .then(function(response) {
            return response.json()
        })
        .then(function(json) {
          if (json.list.length > 0){
            rigs = json
          }
        })
        .finally(function() {
          if (!rigs.list.includes(window.location.host)) {
            rigs.list.unshift(window.location.host)
          }
          rigs.list.forEach(function(ip) {
            rigAddGui(ip)
          })
        })

      // Load logs only if page is visible
      document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
          if (eventSource) {
            eventSource.close()
          }
        } else {
          if (logs.style.display != "none") {
            loadLogs()
          }
        }
      })

      // Check if a rig is open or show full rigs list
      var rigSelectedIp = localStorage.getItem("rigSelectedIp")
      if (rigSelectedIp) {
        rigOpen(rigSelectedIp)
      } else {
        rigsAll.click()
      }
  }.bind(this))()
    </script>
  </body>

  </html>
HTML

# Main server file
# Based on Lua httpd server https://github.com/nmap/nmap/blob/master/ncat/scripts/httpd.lua
cat <<-LUA > "${HTTPD_FILE}"
  --httpd.lua - a dead simple HTTP server. Expects GET requests and serves files
  --matching these requests. Can guess mime based on an extension too. Currently
  --disallows any filenames that start or end with "..".

  ------------------------------------------------------------------------------
  --                          Configuration section                           --
  ------------------------------------------------------------------------------

  server_headers = {
    ["Server"] = "Ncat --lua-exec httpd.lua",
    ["Connection"] = "close",
  }

  function guess_mime(resource)
    if string.sub(resource, -5) == ".html" then return "text/html; charset=utf-8" end
    if string.sub(resource, -5) == ".json" then return "application/json; charset=utf-8" end
    if string.sub(resource, -4) == ".txt" then return "text/plain; charset=utf-8" end
    return "application/octet-stream"
  end

  ------------------------------------------------------------------------------
  --                        End of configuration section                      --
  ------------------------------------------------------------------------------

  function print_rn(str)
    io.stdout:write(str .. "\r\n")
    io.stdout:flush()
  end

  function debug(str)
    io.stderr:write("[" .. os.date() .. "] ")
    io.stderr:write(str .. "\n")
    io.stderr:flush()
  end

  --Read a line of at most 8096 bytes (or whatever the first parameter says)
  --from standard input. Returns the string and a boolean value that is true if
  --we hit the newline (defined as "\n") or false if the line had to be
  --truncated. This is here because io.stdin:read("*line") could lead to memory
  --exhaustion if we received gigabytes of characters with no newline.
  function read_line(max_len)
    local ret = ""
    for i = 1, (max_len or 8096) do
      local chr = io.read(1)
      if chr == "\n" then
        return ret, true
      end
      ret = ret .. (chr or "")
    end

    return ret, false
  end

  --Make a response, output it and stop execution.
  --
  --It takes an associative array with three optional keys: status (status line)
  --and headers, which lists all additional headers to be sent. You can also
  --specify "data" - either a function that is expected to return nil at some
  --point or a plain string.
  function make_response(params)

    --Print the status line. If we got none, assume it is all okay.
    if not params["status"] then
      params["status"] = "HTTP/1.1 200 OK"
    end
    print_rn(params["status"])

    --Send the date.
    print_rn("Date: " .. os.date("!%a, %d %b %Y %H:%M:%S GMT"))

    --Send the server headers as described in the configuration.
    for key, value in pairs(server_headers) do
      print_rn(("%s: %s"):format(key, value))
    end

    --Now send the headers from the parameter, if any.
    if params["headers"] then
      for key, value in pairs(params["headers"]) do
        print_rn(("%s: %s"):format(key, value))
      end
    end

    --If there is any data, check if it is a function.
    if params["data"] then

      if type(params["data"]) == "function" then

        print_rn("")
        --debug("Starting buffered output...")

        --run the function and print its contents, until we hit nil.
        local f = params["data"]
        while true do
          ret = f()
          if ret == nil then
            --debug("Buffered output finished.")
            break
          end
          io.stdout:write(ret)
          io.stdout:flush()
        end

      else

        --It is a plain string. Send its length and output it.
        --debug("Just printing the data. Status: " .. params["status"])
        print_rn("Content-length: " .. params["data"]:len())
        print_rn("")
        io.stdout:write(params["data"])
        io.stdout:flush()

      end
    else
      print_rn("")
    end

    os.exit(0)
  end

  function make_error(error_str)
    make_response({
      ["status"] = "HTTP/1.1 "..error_str,
      ["headers"] = {["Content-type"] = "text/html; charset=utf-8", ["Access-Control-Allow-Origin"] = "*"},
      ["data"] = "<h1>"..error_str.."</h1>",
    })
  end

  do_400 = function() make_error("400 Bad Request") end
  do_403 = function() make_error("403 Forbidden") end
  do_404 = function() make_error("404 Not Found") end
  do_405 = function() make_error("405 Method Not Allowed") end
  do_414 = function() make_error("414 Request-URI Too Long") end

  ------------------------------------------------------------------------------
  --                         End of library section                           --
  ------------------------------------------------------------------------------

  input, success = read_line()

  --We assume that:
  -- * a method is alphanumeric uppercase,
  -- * resource may contain anything that is not a space,
  -- * protocol version is followed by a single space.
  method, resource, protocol = input:match("([A-Z]+) ([^ ]+) ?(.*)")

  --Read json input and save it on buffer
  buffer = ""
  function read_json()
    while true do
      input = read_line() or ""
      --debug("Input: " .. input)
      if string.find(input, "^{") or buffer ~= "" then
        buffer = buffer .. input .. "\n"
      end
      if string.find(input, "^}") then
        break
      end
    end
  end

  --Route processing GET and POST methods:
  -- * GET /, /miner-logs, /device_setings.json, /rigs.json, /nhm.txt, /configuration.txt
  -- * POST /device_setings.json, /rigs.json, /configuration.txt
  -- * /miner-logs is a event-stream using tail -f to monitor log files
  -- * buffer is the acumulator to save POST requests
  if method == "GET" then
    if resource == "/" then
      resource = "${INDEX_FILE}"
    elseif resource == "/${DEVICE_SETTINGS_JSON}" then
      resource = "${NHOS_DATA_DIR}/nhm/configs/${DEVICE_SETTINGS_JSON}"
    elseif resource == "/${RIGS_JSON}" then
      resource = "${NHOS_DATA_DIR}/nhm/configs/${RIGS_JSON}"
    elseif resource == "/${CONFIGURATION_TXT}" then
      resource = "${NHOS_DATA_DIR}/${CONFIGURATION_TXT}"
    elseif resource == "/${NHM_TXT}" then
      resource = "${NHM_TXT_FILE}"
      nhm = io.open(resource, "r")
      if nhm == nil then
        make_response({
          ["status"] = "HTTP/1.1 404 Not Found",
          ["headers"] = {["Content-type"] = "text/plain; charset=utf-8", ["Access-Control-Allow-Origin"] = "*"},
          ["data"] = "No rig information found",
        })
      else
        io.close()
      end
    elseif resource == "/miners-logs" then
      logs = io.popen("tail -f ${NHOS_LOG_NHM_DIR}/miners/*.log ${NHOS_LOG_DIR}/*.log 2>/dev/null")
      make_response({
        ["status"] = "HTTP/1.1 200 Ok",
        ["headers"] = {["Content-type"] = "text/event-stream; charset=utf-8", ["Access-Control-Allow-Origin"] = "*", ["Cache-Control"] = "no-cache",  ["X-Content-Type-Options"] = "nosniff"},
        ["data"] = function() return "data: " .. logs:read ("*l") .. "\n\n" end,
      })
    else
      resource = ""
    end
  elseif method == "POST" then
    if resource == "/${DEVICE_SETTINGS_JSON}" then
      resource = "${NHOS_DATA_DIR}/nhm/configs/${DEVICE_SETTINGS_JSON}"
      read_json()
    elseif resource == "/${RIGS_JSON}" then
      resource = "${NHOS_DATA_DIR}/nhm/configs/${RIGS_JSON}"
      read_json()
    elseif resource == "/${CONFIGURATION_TXT}" then
      resource = "${NHOS_DATA_DIR}/${CONFIGURATION_TXT}"
      read_json()
    elseif resource == "/reboot" then
      os.execute("sudo reboot&")
      make_response({
        ["data"] = "Rebooting...",
        ["headers"] = {["Content-type"] = "text/plain; charset=utf-8", ["Access-Control-Allow-Origin"] = "*", ["Cache-Control"] = "no-cache",  ["X-Content-Type-Options"] = "nosniff"},
      })
    else
      resource = ""
    end
  else
    resource = ""
  end

  --File handling to read and write resources:
  -- * device_settings.json
  -- * rigs.json
  -- * configuration.txt
  json_headers = {["Content-type"] = "application/json; charset=utf-8", ["Access-Control-Allow-Origin"] = "*",  ["Cache-Control"] = "no-cache",  ["X-Content-Type-Options"] = "nosniff"}
  if buffer ~= "" and resource ~= nil then
    f = io.open(resource, "w")
  elseif resource ~= nil then
    f = io.open(resource, "rb")
  end
  if f == nil then
    if resource == "${NHOS_DATA_DIR}/nhm/configs/${DEVICE_SETTINGS_JSON}" then
      --opening file failed, wait NHOS to generate ${DEVICE_SETTINGS_JSON}.
      make_response({
        ["status"] = "HTTP/1.1 404 Not Found",
        ["headers"] = json_headers,
        ["data"] = "{\"detected_devices\": []}",
      })
      debug("Error on resource " .. resource)
    elseif resource == "${NHOS_DATA_DIR}/nhm/configs/${RIGS_JSON}" then
      --opening file failed
      make_response({
        ["status"] = "HTTP/1.1 404 Not Found",
        ["headers"] = json_headers,
        ["data"] = "{\"list\": []}",
      })
      debug("Error on resource " .. resource)
    else
      do_404()
    end
  elseif buffer ~= "" then
    os.execute("chmod +w "..resource)
    f:write(buffer)
    os.execute("chmod -w "..resource)
    if resource == "${NHOS_DATA_DIR}/nhm/configs/${DEVICE_SETTINGS_JSON}" then
      os.execute("sudo killall nhm3 && sudo /opt/nhos/nhm_start&")
    elseif resource == "${NHOS_DATA_DIR}/${CONFIGURATION_TXT}" then
      os.execute("sudo killall nhos_gpu_fan_control && sudo /opt/nhos/nhos_gpu_fan_control&")
    end
    make_response({
      ["data"] = "ok",
      ["headers"] = {["Content-type"] = "text/plain; charset=utf-8", ["Access-Control-Allow-Origin"] = "*", ["Cache-Control"] = "no-cache",  ["X-Content-Type-Options"] = "nosniff"},
    })
  end

  --and output it all.
  make_response({
    ["data"] = function() return f:read(1024) end,
    ["headers"] = {["Content-type"] = guess_mime(resource), ["Access-Control-Allow-Origin"] = "*", ["Cache-Control"] = "no-cache",  ["X-Content-Type-Options"] = "nosniff"},
  })
LUA

# Check rigs saved
rigs_json()
{
  if [ ! -f ${RIGS_JSON_FILE} ]; then
    mkdir -p ${NHOS_DATA_DIR}/nhm/configs
    echo '{"list":[]}' > ${RIGS_JSON_FILE}
  fi
}

RIGS='rigs_json'

# Gets rig info
rig_info()
{
  head -1 ${NHOS_LOG_NHM_DIR}/*.log > ${NHM_TXT_FILE}
  head -2 ${NHOS_LOG_NHM_DIR}/*.log | tail -1 >> ${NHM_TXT_FILE}
}

RIG_INFO='rig_info'

# Adds date to logs
prepend_date()
{
  while IFS= read -r INPUT; do
    echo "[$(date +%D) $(date +%T)] $INPUT"
  done
}

# Monitor thermal slowdown status for nvidia cards
nvidia_smi_monitor()
{
  nvidia-smi -q | grep -q -E 'Product Name|SW'
  if [ $? -eq 0 ]; then
    touch -a ${NVIDIA_GPU_THERMAL_SLOWDOWN_LOG_FILE}
    while sleep 60; do
      nvidia-smi -q | grep -E 'Product Name|SW' | tr -s ' ' | prepend_date > ${NVIDIA_GPU_THERMAL_SLOWDOWN_LOG_FILE}
    done&
  fi
}

NVIDIA_SMI_MONITOR='nvidia_smi_monitor'

# Ncat Lua httpd Server
server_listen()
{
  ncat -n4 -lk -p 80 --lua-exec ${HTTPD_FILE}&
  # Get the current group id
  ps -o pgid,pid | grep $! | awk '{printf $1}' > ${SERVER_PGID}
}

SERVER_LISTEN='server_listen'

# Shellscript like a service https://unix.stackexchange.com/a/236307
case "$1" in
--version)
  echo "$0 v${VERSION}"
  ;;
--help)
  echo "Usage: $0 {start|stop|status|restart}"
  ;;
start)
  if [ -f ${SERVER_PGID} ]; then
    exit 0
  fi
  # Check if NHOS logs are available to execute the server
  while sleep 1; do
    if [ -d ${NHOS_LOG_NHM_DIR} ]; then
      ${RIGS}
      ${RIG_INFO}
      ${NVIDIA_SMI_MONITOR}
      ${SERVER_LISTEN}
      break
    fi
  done&
  ;;
stop)
  if [ -f ${SERVER_PGID} ]; then
    kill -- -`cat ${SERVER_PGID}`
    rm ${SERVER_PGID}
  fi
  ;;
restart)
  sh $0 stop
  sh $0 start
  ;;
status)
  if [ -e ${SERVER_PGID} ]; then
    echo "$0 is running, pgid=`cat ${SERVER_PGID}`"
  else
    echo "$0 is NOT running"
    exit 1
  fi
  ;;
*)
  # Start if not running
  if [ ! -f ${SERVER_PGID} ]; then
    sh $0 start
  fi
esac

exit 0
